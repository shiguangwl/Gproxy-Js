# Gproxy-Js 代理目标配置指南

本文档专门针对 Gproxy-Js 中代理目标的配置、管理和故障排查提供详细指导。

## 1. 代理目标概述

代理目标是 Gproxy-Js 的核心配置项，定义了将请求转发到哪些外部服务器。每个代理目标包含以下关键信息：

- **目标 URL 前缀**：要代理的目标服务器 URL 前缀，如 `https://example.com`
- **是否启用**：控制此代理目标是否生效
- **启用 JS 注入**：是否在代理的 HTML 页面中注入客户端脚本（用于拦截客户端 AJAX/Fetch/WebSocket 请求）
- **备注**：可选的描述信息

## 2. 添加代理目标

### 2.1 通过管理后台添加

1. 登录管理后台（`/admin/login`）
2. 导航到"代理目标"页面（`/admin/targets`）
3. 点击"添加新目标"按钮
4. 填写表单：
   - **目标 URL 前缀**（必填）：输入完整的 URL 前缀，包括协议（http/https）
   - **是否启用**：默认为启用状态
   - **启用 JS 注入**：如果需要代理页面中的客户端请求，请选择此项
   - **备注**：可选，添加描述信息
5. 点击"保存"按钮提交

### 2.2 添加代理目标的最佳实践

- **URL 前缀格式**：确保包含协议（`http://` 或 `https://`）和域名，例如 `https://example.com`
- **特定路径**：如果只想代理特定路径，可以包含路径，例如 `https://example.com/api`
- **不要包含查询参数**：URL 前缀不应包含查询参数（`?`后面的部分）
- **避免重叠前缀**：避免配置重叠的 URL 前缀，以防止路由冲突
- **JS 注入选择**：只有当目标网站包含需要代理的客户端 AJAX/Fetch 请求时才启用 JS 注入

## 3. 编辑和管理代理目标

### 3.1 查看现有代理目标

1. 登录管理后台
2. 导航到"代理目标"页面
3. 查看已配置的代理目标列表，包括状态和配置信息

### 3.2 编辑代理目标

1. 在代理目标列表中，找到需要编辑的目标
2. 点击"编辑"按钮
3. 修改所需字段
4. 点击"保存"按钮提交更改

### 3.3 启用/禁用代理目标

1. 在代理目标列表中，找到需要启用或禁用的目标
2. 使用开关控件或编辑功能更改"是否启用"状态
3. 确认更改

### 3.4 删除代理目标

1. 在代理目标列表中，找到需要删除的目标
2. 点击"删除"按钮
3. 确认删除操作

**注意**：删除代理目标将同时删除与之关联的异步请求策略配置。请谨慎操作。

## 4. 使用代理目标

### 4.1 访问代理目标

配置代理目标后，可以通过以下格式的 URL 访问：

```
https://your-worker-url.workers.dev/proxy/{protocol}/{domain}/{path}
```

例如，如果您配置了目标 URL 前缀 `https://example.com`，则可以通过以下 URL 访问：

```
https://your-worker-url.workers.dev/proxy/https/example.com/
```

要访问子路径，只需在 URL 后面添加路径：

```
https://your-worker-url.workers.dev/proxy/https/example.com/some/path?query=value
```

### 4.2 代理目标与其他功能的关系

- **内容替换规则**：可以为特定代理目标配置内容替换规则
- **异步请求策略**：可以为特定代理目标配置客户端请求处理策略
- **缓存设置**：可以为特定代理目标配置缓存策略

## 5. 故障排查

### 5.1 添加代理目标失败

**问题**：尝试添加代理目标时出现错误。

**可能原因**：
- URL 前缀格式不正确
- URL 前缀已存在（重复）
- 数据库连接问题
- 表单验证错误

**解决方案**：
1. **检查 URL 格式**：
   - 确保 URL 前缀包含协议（`http://` 或 `https://`）
   - 确保 URL 不包含无效字符
   - 尝试简化 URL，只包含协议和域名部分

2. **检查重复项**：
   - 查看现有代理目标列表，确保没有相同的 URL 前缀
   - 如果需要代理相同域名的不同路径，请使用更具体的 URL 前缀

3. **检查数据库连接**：
   - 确认 D1 数据库连接正常
   - 检查 Worker 日志中是否有数据库错误
   - 运行 `wrangler d1 execute DB "SELECT * FROM proxied_targets"` 验证数据库表是否正常

4. **检查表单验证**：
   - 查看浏览器控制台是否有 JavaScript 错误
   - 确保所有必填字段都已填写
   - 尝试使用更简单的值重新提交

5. **检查 Worker 日志**：
   - 使用 `wrangler tail` 命令查看实时日志
   - 查找与添加代理目标相关的错误消息

### 5.2 代理目标无法访问

**问题**：配置了代理目标，但无法通过代理 URL 访问。

**可能原因**：
- 代理目标未启用
- URL 格式错误
- 目标服务器拒绝请求
- Worker 错误

**解决方案**：
1. **检查代理目标状态**：
   - 确认代理目标的"是否启用"设置为启用状态
   - 尝试编辑并重新保存代理目标

2. **验证访问 URL**：
   - 确保使用正确的代理 URL 格式
   - 检查域名和路径拼写是否正确

3. **检查目标服务器**：
   - 尝试直接访问目标网站，确认其是否正常运行
   - 检查目标服务器是否有地理位置限制或 IP 封锁

4. **检查 Worker 日志**：
   - 查看代理请求的日志
   - 检查是否有错误消息或异常

5. **尝试简化配置**：
   - 临时禁用内容替换规则和异步请求策略
   - 使用简单的静态网站作为测试目标

### 5.3 JS 注入问题

**问题**：启用了 JS 注入，但客户端请求未被代理。

**可能原因**：
- 客户端脚本未正确加载
- 异步请求策略配置错误
- 目标网站使用了复杂的脚本加载机制
- 浏览器扩展干扰

**解决方案**：
1. **检查客户端脚本加载**：
   - 使用浏览器开发者工具检查网络请求
   - 确认 `proxy_client.js` 是否成功加载
   - 查看控制台是否有 JavaScript 错误

2. **检查异步请求策略**：
   - 确认是否配置了适当的异步请求策略
   - 验证策略的 URL 模式是否正确匹配目标请求

3. **测试简单场景**：
   - 创建一个简单的 HTML 页面，包含基本的 AJAX 请求
   - 通过代理访问并验证功能

4. **排除浏览器扩展干扰**：
   - 使用无痕模式或禁用所有扩展后测试
   - 尝试不同的浏览器

### 5.4 特定网站代理问题

**问题**：某些特定网站无法正确代理。

**可能原因**：
- 网站使用了复杂的 CSP (Content Security Policy)
- 网站使用了反代理检测机制
- 网站依赖于特定的 Cookie 或会话机制
- 网站使用了复杂的客户端路由

**解决方案**：
1. **检查并修改 CSP**：
   - 使用响应头规则修改 CSP 头
   - 移除阻止内联脚本的 CSP 限制

2. **配置自定义请求头**：
   - 添加常见的请求头如 `User-Agent`
   - 尝试模拟正常浏览器行为

3. **处理 Cookie 和会话**：
   - 确保 Cookie 正确传递
   - 对于依赖严格会话的网站，可能需要特殊处理

4. **针对复杂客户端路由**：
   - 配置特定的内容替换规则
   - 考虑注入自定义脚本处理路由

## 6. 高级配置

### 6.1 多目标代理

如果需要代理多个相关的服务，可以配置多个代理目标：

1. 主网站：`https://example.com`
2. API 服务：`https://api.example.com`
3. 静态资源：`https://static.example.com`

确保为每个目标配置适当的异步请求策略，以便客户端请求能正确路由。

### 6.2 URL 重写

对于需要在代理过程中修改 URL 的情况，可以使用内容替换规则：

1. 添加一个替换规则，搜索模式为原始 URL 模式
2. 将替换内容设置为新的 URL 格式
3. 选择适当的匹配类型（字符串或正则表达式）

### 6.3 请求头修改

要修改发送到目标服务器的请求头：

1. 导航到"请求头规则"页面（如果已实现）
2. 添加新的请求头规则
3. 选择"请求"阶段
4. 配置要添加、修改或删除的头部

### 6.4 响应头修改

要修改从目标服务器返回的响应头：

1. 导航到"请求头规则"页面
2. 添加新的请求头规则
3. 选择"响应"阶段
4. 配置要添加、修改或删除的头部

## 7. 最佳实践

### 7.1 性能优化

- 只在必要时启用 JS 注入
- 使用精确的 URL 前缀，避免过于通用的配置
- 为频繁访问的目标配置缓存策略
- 避免过多或过于复杂的内容替换规则

### 7.2 安全考虑

- 定期审核代理目标列表，移除不再使用的目标
- 避免代理敏感内容或需要认证的服务
- 考虑为管理后台配置 IP 访问限制
- 注意目标网站的使用条款和服务条款

### 7.3 维护建议

- 为每个代理目标添加清晰的备注
- 定期测试代理功能
- 保持 Gproxy-Js 更新到最新版本
- 记录配置更改和问题

## 8. 常见用例示例

### 8.1 代理内部网络应用

**场景**：将内部网络应用通过 Cloudflare Workers 代理到公共互联网。

**配置**：
1. 添加代理目标：`http://internal-app.local`
2. 启用 JS 注入
3. 添加请求头规则，设置内部认证信息
4. 配置内容替换规则，替换内部 URL 引用

### 8.2 内容过滤代理

**场景**：代理公共网站但过滤特定内容。

**配置**：
1. 添加代理目标：`https://public-site.com`
2. 启用 JS 注入
3. 添加内容替换规则，搜索模式为不需要的内容模式
4. 将替换内容设置为空字符串或替代内容

### 8.3 API 代理

**场景**：代理第三方 API 并添加认证信息。

**配置**：
1. 添加代理目标：`https://api.third-party.com`
2. 禁用 JS 注入（通常 API 不需要）
3. 添加请求头规则，设置 API 密钥或认证信息
4. 配置缓存策略减少 API 调用

## 9. 代理目标数据库结构

代理目标存储在 `proxied_targets` 表中，结构如下：

```sql
CREATE TABLE IF NOT EXISTS proxied_targets (
    id TEXT PRIMARY KEY,
    target_url_prefix TEXT UNIQUE NOT NULL,
    is_active INTEGER DEFAULT 1, -- 0 for false, 1 for true
    enable_js_injection INTEGER DEFAULT 0, -- 0 for false, 1 for true
    notes TEXT,
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);
```

如果需要直接操作数据库（不推荐，但在故障排查时可能有用）：

```bash
# 列出所有代理目标
wrangler d1 execute DB "SELECT * FROM proxied_targets"

# 检查特定目标
wrangler d1 execute DB "SELECT * FROM proxied_targets WHERE target_url_prefix = 'https://example.com'"

# 手动添加代理目标（仅用于故障排查）
wrangler d1 execute DB "INSERT INTO proxied_targets (id, target_url_prefix, is_active, enable_js_injection) VALUES ('manual-id', 'https://example.com', 1, 1)"

# 手动启用/禁用代理目标
wrangler d1 execute DB "UPDATE proxied_targets SET is_active = 1 WHERE id = 'target-id'"
```

## 10. 联系支持

如果您在配置代理目标时遇到无法解决的问题，请通过以下方式寻求帮助：

1. 在 GitHub 仓库提交 Issue：[https://github.com/yourusername/gproxy-js/issues](https://github.com/yourusername/gproxy-js/issues)
2. 提供详细的问题描述、错误消息和复现步骤
3. 包含您的环境信息（Wrangler 版本、浏览器版本等）
4. 如果可能，提供目标网站的公共 URL 和您尝试的代理配置 